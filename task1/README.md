# Основные фай

* [lib.php](lib.php) - Файл с функциями
* [worker.php](worker.php) - "Точка входа"
* [db.sql](db.sql) - структара БД
* [fill_user.php](fill_user.php) - Скрипт для заполнения БД

## Описание
* Для выполнения своевременной рассылок необхожимо параллеить процесс отправки.
* Из исходных данных:
  * 5 000 000 пользователь, из них ~20% подписчики
  * подписка на 31 день
  * равномерное распределение во времени
* Получаем примерно ~33 000 отправко в сутки, или ~1400 в час
* Время на работу скрипта для отправки уведомлений
  * среднее время проверки почты на валидность ~30 секунд
  * среднее время отправки почты ~5 секунд
* Итого 35 секунд на одно письмо (для предупреждении за сутки будет сильно меньше, так как уже будет проверен email при отправки за 3 дня, для однодневного предупреждения можно принять ~10 секунд на отправку)
* Получаем, что для отправки трех-дневного предупреждения требуется 14 воркеров, а для отправки однодневного 4 воркера

  
Скриптом [worker.php](worker.php) можно запустить процесс рассылки с указаниме конкретного количества задействованных процессов, так и с указанием автоматического выбора.
В автоматическом режиме скрипт подстраивает количество процессов в зависимости от размеров скопившей очереди, что позволят не отслеживать случайные перекосы в сторону увеличения количества отправок.

## Для запуска из cron
```cron
15,45 * * * * cd /home/sites/test-case1/ && php worker.php day3 1600 auto 50
0,30 * * * * cd /home/sites/test-case1/ && php worker.php day1 1600 auto 50
```

## Для запуска из supervisor
```conf
[program:day3-sender]
directory=/home/sites/test-case1/
command=php worker.php day3 1800 auto 50
autostart=true
autorestart=true
stderr_logfile=/var/log/worker3.log
stdout_logfile=/var/log/worker3.log

[program:day1-sender]
directory=/home/sites/test-case1/
command=php worker.php day1 1800 auto 50
autostart=true
autorestart=true
stderr_logfile=/var/log/worker1.log
stdout_logfile=/var/log/worker1.log
```


# "Бонус": Мониторинг работы
[График количества задач в очереди на отправку и количества воркеров](http://test-case1.tale.webtricks.pro/)

![Скриншот графика](Screensho_1.jpg)
